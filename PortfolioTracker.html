<!DOCTYPE html>
<html lang="zh-CN" class=""> <!-- Default class is empty, JS will handle theme -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Observation List - Market Data</title>
    
    <!-- Google Fonts & Your Existing CSS -->
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <!-- Assuming you have a style.css for Tailwind. If not, the CDN below will provide basic styles. -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

    <style>
        /* A few helper styles for loading state */
        @keyframes pulse { 50% { opacity: .6; } }
        .skeleton { 
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; 
            background-color: #e5e7eb; /* light mode skeleton color */
            border-radius: 0.25rem;
        }
        .dark .skeleton {
            background-color: #374151; /* dark mode skeleton color */
        }
        
        /* Styles for sortable table headers */
        .sortable-header {
            cursor: pointer;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard syntax */
        }
        .sortable-header .sort-indicator {
            color: #9ca3af; /* Tailwind gray-400 */
            display: inline-block;
            width: 1em; /* Reserve space for the icon */
        }
        .sortable-header[data-sort-dir] .sort-indicator {
             color: #1f2937; /* Tailwind gray-800 */
        }
        .dark .sortable-header[data-sort-dir] .sort-indicator {
             color: #e5e7eb; /* Tailwind gray-200 */
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="mb-8">
            <div>
                <h1 class="text-4xl font-bold text-gray-900 dark:text-white">Market Data Dashboard</h1>
                <p id="status-text" class="text-lg text-gray-600 dark:text-dark-subtle mt-1">Observation List</p>
            </div>
        </header>

        <!-- Main Content Grid -->
        <div class="space-y-8">
            <div class="grid grid-cols-1">
                <div class="bg-white dark:bg-dark-card p-6 rounded-2xl shadow-md border border-gray-200 dark:border-dark-border">
                    <h2 class="text-xl font-semibold mb-4">Observation List</h2>
                    <div id="stock-observe-container" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- CONFIGURATION ---
            const GITHUB_USER = 'digital-era';
            const GITHUB_REPO = 'AIPEHotTracker';
            const DATA_PATH = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/data`;
            
            // Simplified data sources to only include the observation list
            const dataSources = [
                { id: 'stock-observe', file: 'stock_observe_data.json', renderer: renderAFlatTable, isSortable: true }
            ];

            // --- UI ELEMENTS ---
            const statusText = document.getElementById('status-text');

            // --- THEME SETUP LOGIC ---
            // This sets the theme on initial load based on localStorage, but removes the toggle button functionality.
            if (localStorage.getItem('color-theme') === 'light' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: light)').matches)) {
                document.documentElement.classList.remove('dark');
            } else {
                document.documentElement.classList.add('dark');
            }

            // Function to generate stock URL
            const getStockUrl = (code) => {
                let baseinitialUrl = 'https://aipeinvestmentagent.pages.dev';
                const sharedOrigin = localStorage.getItem('sharedReferrerOrigin')
                if (sharedOrigin) {
                        baseinitialUrl = sharedOrigin;
                }
                const baseUrl = `${baseinitialUrl}/PotScoreFundAnalytics?stock=`;
                
                const codeStr = String(code);
                const isHkStock = codeStr.length === 5 && /^\d+$/.test(codeStr);
                const codeToEncode = isHkStock ? `HK${codeStr}` : codeStr;
                return `${baseUrl}${encodeURIComponent(codeToEncode)}`;
            };

            // --- DATA RENDERING FUNCTIONS ---
            const renderSkeleton = (containerId) => {
                const container = document.getElementById(containerId);
                if (!container) return;
                const skeletonRow = `<tr><td class="py-2.5 px-4"><div class="h-4 skeleton w-full"></div></td><td class="py-2.5 px-4"><div class="h-4 skeleton w-3/4"></div></td></tr>`.repeat(5);
                const skeletonTable = `<div class="w-full"><table class="w-full"><tbody>${skeletonRow}</tbody></table></div>`;
                container.innerHTML = skeletonTable;
            };
            
            function renderAFlatTable(containerId, data, isSortable = false) {
                const container = document.getElementById(containerId);
                if (!container || !data || data.error || !Array.isArray(data)) {
                    container.innerHTML = `<p class="text-red-500">Load failed: ${data?.error || 'Invalid data'}</p>`; return;
                }
                 if (data.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No data available in the observation list.</p>';
                    return;
                }
                let rows = data.map(item => {
                     const percentClass = item.Percent >= 0 ? 'text-green-500' : 'text-red-500';
                     const url = getStockUrl(item['代码']);
                     return `<tr>
                                <td class="py-2 px-4 font-medium text-gray-900 dark:text-white whitespace-nowrap">
                                    <a href="${url}" target="_blank" class="hover:underline">${item['名称']}</a>
                                </td>
                                <td class="py-2 px-4 text-gray-500 dark:text-gray-400">${item['代码']}</td>
                                <td class="py-2 px-4 text-right ${percentClass}">${item.Percent != null ? item.Percent.toFixed(2) : '-'}%</td>
                                <td class="py-2 px-4 text-right">${item.Price != null ? item.Price.toFixed(2) : '-'}</td>
                                <td class="py-2 px-4 text-right">${item.PE_TTM != null ? item.PE_TTM.toFixed(2) : '-'}</td>
                                <td class="py-2 px-4 text-right">${item.PB != null ? item.PB.toFixed(2) : '-'}</td>
                                <td class="py-2 px-4 text-right">${item.Amount != null ? item.Amount.toFixed(2) : '-'}</td>
                            </tr>`;
                }).join('');
                
                const headers = [
                    { label: 'Name', type: 'string' },
                    { label: 'Code', type: 'string' },
                    { label: 'Change %', type: 'number', align: 'right' },
                    { label: 'Price', type: 'number', align: 'right' },
                    { label: 'PE(TTM)', type: 'number', align: 'right' },
                    { label: 'PB', type: 'number', align: 'right' },
                    { label: 'Amount(亿)', type: 'number', align: 'right' }
                ];
                const headerHtml = headers.map(h => {
                    const alignClass = h.align === 'right' ? 'text-right' : '';
                    if (isSortable) {
                        return `<th class="px-4 py-3 ${alignClass} sortable-header hover:bg-gray-200 dark:hover:bg-gray-600" data-sort-type="${h.type}">${h.label}<span class="sort-indicator"></span></th>`;
                    }
                    return `<th class="px-4 py-3 ${alignClass}">${h.label}</th>`;
                }).join('');

                container.innerHTML = `<div class="overflow-x-auto rounded-lg border dark:border-gray-700"><table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-100 dark:bg-gray-700"><tr>${headerHtml}</tr></thead><tbody class="divide-y dark:divide-gray-700">${rows}</tbody></table></div>`;
            }
            
            async function fetchAndRenderData() {
                statusText.textContent = 'Fetching latest data file...';

                // Render skeleton loader
                renderSkeleton('stock-observe-container');

                const source = dataSources[0]; // We only have one source
                
                try {
                    const response = await fetch(`${DATA_PATH}/${source.file}?t=${new Date().getTime()}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    const text = await response.text();
                    const data = JSON.parse(text.replace(/NaN/g, 'null'));

                    // Render the data
                    source.renderer(`${source.id}-container`, data, source.isSortable);

                    // Update status text
                    let lastUpdateTime = "N/A", tradeDate = "N/A";
                    if (data && !data.error && Array.isArray(data) && data.length > 0) {
                        lastUpdateTime = data[0].update_time_bjt || "N/A";
                        tradeDate = data[0].trade_date || "N/A";
                    }
                     statusText.textContent = `Last updated (BJT): ${lastUpdateTime} | Trade Date: ${tradeDate}`;

                } catch (error) {
                    const data = { error: error.message, id: source.id };
                    source.renderer(`${source.id}-container`, data, source.isSortable);
                    statusText.textContent = `Data fetch failed.`;
                }
            }
            
            function setupTableSorting() {
                document.addEventListener('click', function (e) {
                    const th = e.target.closest('th.sortable-header');
                    if (!th) return;

                    const table = th.closest('table');
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const colIndex = th.cellIndex;
                    const sortType = th.dataset.sortType;
                    const currentDir = th.dataset.sortDir || 'desc';
                    const newDir = currentDir === 'asc' ? 'desc' : 'asc';

                    // Reset other headers
                    table.querySelectorAll('th.sortable-header').forEach(header => {
                        header.removeAttribute('data-sort-dir');
                        header.querySelector('.sort-indicator').textContent = '';
                    });
                    // Set current header
                    th.dataset.sortDir = newDir;
                    th.querySelector('.sort-indicator').textContent = newDir === 'asc' ? '▲' : '▼';

                    rows.sort((rowA, rowB) => {
                        const valA_raw = rowA.cells[colIndex].textContent.trim();
                        const valB_raw = rowB.cells[colIndex].textContent.trim();
                        let valA, valB;
                        if (sortType === 'number') {
                            const parse = (val) => {
                                if (val === '-') return newDir === 'asc' ? Infinity : -Infinity;
                                return parseFloat(val.replace(/%|,/g, '')) || (newDir === 'asc' ? Infinity : -Infinity);
                            };
                            valA = parse(valA_raw);
                            valB = parse(valB_raw);
                        } else {
                            valA = valA_raw.toLowerCase();
                            valB = valB_raw.toLowerCase();
                        }
                        if (valA < valB) return newDir === 'asc' ? -1 : 1;
                        if (valA > valB) return newDir === 'asc' ? 1 : -1;
                        return 0;
                    });
                    tbody.innerHTML = '';
                    rows.forEach(row => tbody.appendChild(row));
                });
            }

            // --- INITIALIZATION ---
            function initialize() {
                statusText.textContent = 'Loading initial data...';
                setupTableSorting();
                fetchAndRenderData();
            }

            initialize();
        });
    </script>

</body>
</html>```
